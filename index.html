<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DorGPT Wrapped ‚Äî Local Stats</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.085);
      --border: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.55);
      --a:#62f6d2; --b:#ff7ad9; --c:#ffd166; --d:#7aa7ff; --e:#b9ff6a;
      --r:20px; --r2:16px;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(1100px 800px at 10% 10%, rgba(98,246,210,.14), transparent 55%),
        radial-gradient(900px 700px at 90% 15%, rgba(255,122,217,.12), transparent 55%),
        radial-gradient(900px 700px at 70% 90%, rgba(122,167,255,.10), transparent 55%),
        radial-gradient(700px 600px at 15% 90%, rgba(255,209,102,.10), transparent 55%),
        linear-gradient(180deg, #0b0f14 0%, #070a0e 100%);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 16px 80px}
    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 0 10px;
      background: linear-gradient(180deg, rgba(11,15,20,.92), rgba(11,15,20,.40) 70%, transparent);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:36px;height:36px;border-radius:12px;
      background:
        radial-gradient(12px 12px at 25% 35%, var(--a), transparent 60%),
        radial-gradient(14px 14px at 70% 25%, var(--b), transparent 60%),
        radial-gradient(14px 14px at 62% 75%, var(--d), transparent 60%),
        radial-gradient(16px 16px at 28% 78%, var(--c), transparent 60%),
        rgba(255,255,255,.06);
      box-shadow: 0 0 0 1px rgba(255,255,255,.10), 0 16px 40px rgba(0,0,0,.45);
      flex:0 0 auto;
    }
    h1{font-size:14px;margin:0;font-weight:850;letter-spacing:.2px}
    .sub{font-size:12px;color:var(--muted2);margin-top:2px}
    .controls{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:800;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    button:hover{transform:translateY(-1px);background:rgba(255,255,255,.09);border-color:rgba(255,255,255,.18)}
    button:active{transform:translateY(0) scale(.99)}
    button.primary{border-color: rgba(98,246,210,.28); background: linear-gradient(135deg, rgba(98,246,210,.16), rgba(122,167,255,.12));}
    button.warn{border-color: rgba(255,209,102,.28); background: linear-gradient(135deg, rgba(255,209,102,.16), rgba(255,122,217,.10));}
    .hero{
      border:1px solid var(--border);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.065), rgba(255,255,255,.03));
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      padding:18px;
      overflow:hidden;
      position:relative;
    }
    .hero::before{
      content:""; position:absolute; inset:-2px; pointer-events:none;
      background:
        radial-gradient(520px 260px at 20% 0%, rgba(98,246,210,.18), transparent 60%),
        radial-gradient(520px 300px at 85% 15%, rgba(255,122,217,.14), transparent 62%),
        radial-gradient(540px 340px at 70% 95%, rgba(122,167,255,.12), transparent 62%);
      filter: blur(2px);
      opacity:.95;
    }
    .heroInner{position:relative;display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media (max-width:900px){.heroInner{grid-template-columns:1fr}}
    .pillRow{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .pill{
      font-size:12px;color:rgba(255,255,255,.8);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      padding:7px 10px;border-radius:999px;
    }
    .hero h2{margin:0 0 8px;font-size: clamp(24px, 3vw, 38px);letter-spacing:-.6px;line-height:1.06}
    .hero p{margin:0;color:var(--muted);font-size:14px;line-height:1.55;max-width:72ch}
    .miniGrid{display:grid;gap:10px}
    .mini{
      border:1px solid var(--border);
      border-radius: var(--r2);
      background: rgba(255,255,255,.05);
      padding:12px;
    }
    .mini .label{font-size:12px;color:rgba(255,255,255,.62);display:flex;justify-content:space-between;gap:10px}
    .mini .value{margin-top:6px;font-size:16px;font-weight:900}
    .mini .hint{margin-top:6px;font-size:12px;color:rgba(255,255,255,.55);line-height:1.45}
    .grid{margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--border);
      border-radius: var(--r);
      background: rgba(255,255,255,.05);
      box-shadow: 0 0 0 1px rgba(255,255,255,.06), 0 18px 60px rgba(0,0,0,.35);
      padding:14px;
    }
    .card h3{margin:0;font-size:15px;letter-spacing:-.2px}
    .meta{margin-top:3px;color:var(--muted2);font-size:12px;line-height:1.35}
    .kvs{margin-top:12px;display:grid;gap:10px}
    .kv{
      display:flex;gap:10px;align-items:flex-start;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      border-radius: 16px;
      padding:12px;
    }
    .dot{width:10px;height:10px;border-radius:50%;margin-top:5px;flex:0 0 auto;
      box-shadow: 0 0 0 1px rgba(255,255,255,.12), 0 0 30px rgba(255,255,255,.06);}
    .dot.a{background:var(--a)} .dot.b{background:var(--b)} .dot.c{background:var(--c)} .dot.d{background:var(--d)} .dot.e{background:var(--e)}
    .kv b{display:block;font-size:13px;margin-bottom:2px}
    .kv span{display:block;font-size:13px;color:var(--muted);line-height:1.45}
    .chartWrap{margin-top:12px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.10);border-radius:16px;padding:12px}
    canvas{width:100%;height:180px;display:block}
    .legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px;font-size:12px;color:rgba(255,255,255,.62)}
    .swatch{width:10px;height:10px;border-radius:3px;display:inline-block;margin-right:6px;border:1px solid rgba(255,255,255,.16)}
    /* Modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(8px);display:none;z-index:100;padding:18px}
    .modal{max-width:820px;margin:6vh auto;border-radius:22px;border:1px solid rgba(255,255,255,.14);background:rgba(11,15,20,.90);
      box-shadow:0 24px 90px rgba(0,0,0,.65);overflow:hidden}
    .mHead{padding:16px;border-bottom:1px solid rgba(255,255,255,.10);background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03))}
    .mHead h4{margin:0;font-size:14px}
    .mHead p{margin:6px 0 0;font-size:12px;color:rgba(255,255,255,.62);line-height:1.45}
    .mBody{padding:16px;display:grid;gap:12px}
    .dz{border:1px dashed rgba(255,255,255,.18);background:rgba(0,0,0,.20);border-radius:18px;padding:16px;display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .mono{font-family:var(--mono);font-size:12px;color:rgba(255,255,255,.70);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:8px 10px;overflow:auto}
    input[type=file]{display:none}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      max-width:min(720px, calc(100vw - 24px));
      padding:12px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.55);backdrop-filter:blur(10px);
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      color:rgba(255,255,255,.86);font-size:12px;display:none;z-index:120;
    }
    .toast code{font-family:var(--mono);background:rgba(255,255,255,.08);padding:2px 6px;border-radius:8px;border:1px solid rgba(255,255,255,.10)}
    #fx{position:fixed;inset:0;pointer-events:none;z-index:110}
  </style>
</head>
<body>
<canvas id="fx"></canvas>

<!-- Modal -->
<div class="backdrop" id="backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <div class="mHead">
      <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap">
        <div>
          <h4 id="mTitle">Import Stats (local only)</h4>
          <p>Upload <b>conversations.json</b> from your ChatGPT export. Parsing happens in your browser; nothing is uploaded.</p>
        </div>
        <button id="btnClose">Close</button>
      </div>
    </div>
    <div class="mBody">
      <div class="dz" id="dz">
        <div>
          <b>Drop file here</b>
          <div style="margin-top:6px;font-size:12px;color:rgba(255,255,255,.62)">
            Accepted: <span class="mono">conversations.json</span>
          </div>
        </div>
        <div class="row">
          <label for="file" style="cursor:pointer" class="mono">Choose file</label>
          <input id="file" type="file" accept=".json,application/json"/>
          <button class="primary" id="btnParse" disabled>Parse & Build</button>
        </div>
      </div>
      <div class="row">
        <div id="status" style="font-size:12px;color:rgba(255,255,255,.65)">No file selected yet.</div>
        <div class="mono" id="meta">‚Äî</div>
      </div>
      <div class="mono">
        Tip: In ChatGPT ‚Üí Settings ‚Üí Data Controls ‚Üí Export data ‚Üí unzip ‚Üí find <b>conversations.json</b>.
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>DorGPT Wrapped ‚Äî Local Stats</h1>
        <div class="sub" id="sub">Buttons guaranteed. No external libs. ‚úÖ</div>
      </div>
    </div>
    <div class="controls">
      <button class="primary" id="btnImport" type="button">Import Stats</button>
      <button id="btnSpark" type="button">Spark ‚ú®</button>
      <button id="btnReset" class="warn" type="button">Reset</button>
    </div>
  </div>

  <section class="hero">
    <div class="heroInner">
      <div>
        <div class="pillRow">
          <span class="pill" id="pillStats">Stats: Inferred</span>
          <span class="pill" id="pillRange">Range: ‚Äî</span>
          <span class="pill">Press D for confetti</span>
        </div>
        <h2 id="title">Dor √ó ChatGPT ‚Äî The Thinking Companion Dashboard</h2>
        <p id="summary">Import your conversations.json to compute real message counts, activity timeline, keyword themes, and signature moves ‚Äî locally in your browser.</p>
      </div>
      <div class="miniGrid">
        <div class="mini">
          <div class="label"><span>Vibe</span><span class="pill" style="padding:6px 10px">live</span></div>
          <div class="value" id="vibe">High-taste + high iteration</div>
          <div class="hint" id="vibeHint">Will become data-backed after import.</div>
        </div>
        <div class="mini">
          <div class="label"><span>Primary mode</span><span style="font-size:12px;color:rgba(255,255,255,.55)" id="modeTag">(estimated)</span></div>
          <div class="value" id="mode">Co-designer & co-writer</div>
          <div class="hint" id="modeHint">Work + creative + tool-chaining.</div>
        </div>
      </div>
    </div>
  </section>

  <section class="grid">
    <article class="card">
      <h3>Key Stats</h3>
      <div class="meta">Real numbers after import</div>
      <div class="kvs">
        <div class="kv"><div class="dot d"></div><div><b>Total conversations</b><span id="kConvos">‚Äî</span></div></div>
        <div class="kv"><div class="dot a"></div><div><b>Total messages</b><span id="kMsgs">‚Äî</span></div></div>
        <div class="kv"><div class="dot b"></div><div><b>User vs assistant</b><span id="kRatio">‚Äî</span></div></div>
        <div class="kv"><div class="dot c"></div><div><b>Estimated words typed (user)</b><span id="kWords">‚Äî</span></div></div>
        <div class="kv"><div class="dot e"></div><div><b>Active days</b><span id="kDays">‚Äî</span></div></div>
      </div>
    </article>

    <article class="card">
      <h3>Activity Timeline</h3>
      <div class="meta">Messages per month</div>
      <div class="chartWrap">
        <canvas id="chart" width="900" height="240"></canvas>
        <div class="legend">
          <span><span class="swatch" style="background:rgba(98,246,210,.85)"></span>Messages/month</span>
          <span><span class="swatch" style="background:rgba(255,122,217,.25)"></span>User share (bar)</span>
        </div>
      </div>
    </article>

    <article class="card">
      <h3>Signature Moves</h3>
      <div class="meta">Detected from your phrasing (user messages)</div>
      <div class="kvs" id="sig">
        <div class="kv"><div class="dot b"></div><div><b>Waiting for import</b><span>Upload conversations.json to generate this list.</span></div></div>
      </div>
    </article>

    <article class="card">
      <h3>Top Keywords</h3>
      <div class="meta">Simple frequency (English + Hebrew), with stopwords removed</div>
      <div class="kvs" id="kw">
        <div class="kv"><div class="dot a"></div><div><b>Waiting for import</b><span>Upload conversations.json to populate keywords.</span></div></div>
      </div>
    </article>
  </section>
</div>

<div class="toast" id="toast"></div>

<script>
  // --- tiny utilities ---
  const $ = (id) => document.getElementById(id);
  const toast = $("toast");
  function showToast(html, ms=2600){
    toast.innerHTML = html;
    toast.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.style.display="none", ms);
  }
  function fmtInt(n){ return (n ?? 0).toLocaleString(); }
  function clamp01(x){ return Math.max(0, Math.min(1, x)); }
  function pct(x){ return Math.round(clamp01(x) * 100) + "%"; }
  function wordsCount(s){ return (s||"").trim().split(/\s+/).filter(Boolean).length; }
  function fmtDate(d){ return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0"); }

  // --- confetti (press D) ---
  const fx = $("fx");
  const ctx = fx.getContext("2d");
  let particles = [];
  const palette = [[98,246,210],[255,122,217],[255,209,102],[122,167,255],[185,255,106]];
  function resize(){ fx.width = innerWidth * devicePixelRatio; fx.height = innerHeight * devicePixelRatio; }
  addEventListener("resize", resize); resize();
  function rand(a,b){ return Math.random()*(b-a)+a; }
  function confetti(n=140){
    const x = fx.width*0.5, y = fx.height*0.20;
    for(let i=0;i<n;i++){
      const col = palette[(Math.random()*palette.length)|0];
      particles.push({x,y,vx:rand(-4.5,4.5)*devicePixelRatio,vy:rand(-7.5,-2.5)*devicePixelRatio,
        g:rand(0.12,0.22)*devicePixelRatio,r:rand(2,5.2)*devicePixelRatio,a:1,rot:rand(0,Math.PI),vr:rand(-0.18,0.18),col});
    }
  }
  function tick(){
    ctx.clearRect(0,0,fx.width,fx.height);
    particles = particles.filter(p=>p.a>0.02);
    for(const p of particles){
      p.vy += p.g; p.x += p.vx; p.y += p.vy; p.rot += p.vr; p.a *= 0.985;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.globalAlpha=p.a;
      ctx.fillStyle = `rgb(${p.col[0]},${p.col[1]},${p.col[2]})`;
      ctx.fillRect(-p.r, -p.r/2, p.r*2, p.r);
      ctx.restore();
    }
    requestAnimationFrame(tick);
  }
  tick();
  addEventListener("keydown",(e)=>{ if(e.key.toLowerCase()==="d"){ confetti(); showToast("Dor mode activated üéâ"); } });

  // --- Spark button ---
  const sparks = [
    ["Modest confidence, maximum craft","Co-designer & co-strategist"],
    ["Systems + soul + a dash of chaos","Thinking partner & creative director"],
    ["High standards, kind delivery","UX mentor & tone polisher"],
    ["Build-first brain (with taste)","Maker & messenger"],
    ["Clarity hunter, vibe keeper","Educator & producer"],
  ];
  $("btnSpark").addEventListener("click", ()=>{
    const [v,m] = sparks[(Math.random()*sparks.length)|0];
    $("vibe").textContent = v;
    $("mode").textContent = m;
    confetti(70);
    showToast(`‚ú® Sparked: <b>${v}</b>`);
  });

  // --- Modal open/close ---
  const backdrop = $("backdrop");
  function openModal(){ backdrop.style.display="block"; }
  function closeModal(){ backdrop.style.display="none"; }
  $("btnImport").addEventListener("click", openModal);
  $("btnClose").addEventListener("click", closeModal);
  backdrop.addEventListener("click", (e)=>{ if(e.target===backdrop) closeModal(); });

  // --- Reset ---
  $("btnReset").addEventListener("click", ()=>{
    localStorage.removeItem("dorgpt_stats_cache_v0");
    location.reload();
  });

  // --- Import handling (conversations.json only) ---
  const fileInput = $("file");
  const dz = $("dz");
  const btnParse = $("btnParse");
  let selected = null;

  function setSelected(f){
    selected = f;
    if(!f){
      btnParse.disabled = true;
      $("status").textContent = "No file selected yet.";
      $("meta").textContent = "‚Äî";
      return;
    }
    btnParse.disabled = false;
    $("status").textContent = "Ready to parse locally.";
    $("meta").textContent = `${f.name} ¬∑ ${fmtInt(f.size)} bytes`;
  }
  fileInput.addEventListener("change", ()=> setSelected(fileInput.files?.[0] || null));

  dz.addEventListener("dragover",(e)=>{ e.preventDefault(); dz.style.borderColor="rgba(98,246,210,.35)"; });
  dz.addEventListener("dragleave",()=>{ dz.style.borderColor="rgba(255,255,255,.18)"; });
  dz.addEventListener("drop",(e)=>{
    e.preventDefault(); dz.style.borderColor="rgba(255,255,255,.18)";
    const f = e.dataTransfer.files?.[0];
    if(f) setSelected(f);
  });

  function safeJson(str){ try{return JSON.parse(str);}catch(_){return null;} }
  function readText(file){
    return new Promise((res,rej)=>{
      const r = new FileReader();
      r.onload=()=>res(String(r.result||""));
      r.onerror=()=>rej(r.error);
      r.readAsText(file);
    });
  }

  // ChatGPT export parsing (robust-ish)
  function extractText(msg){
    try{
      const c = msg?.content;
      if(!c) return "";
      if(Array.isArray(c.parts)) return c.parts.filter(Boolean).join("\n");
      if(typeof c.text === "string") return c.text;
      if(c.content_type && Array.isArray(c.parts)) return c.parts.join("\n");
    }catch(_){}
    return "";
  }
  function linearize(conv){
    const nodes = conv?.mapping;
    const cur = conv?.current_node;
    if(!nodes || !cur || !nodes[cur]) return [];
    const chain = [];
    let n = nodes[cur];
    const seen = new Set();
    while(n && !seen.has(n.id)){
      seen.add(n.id);
      if(n.message) chain.push(n);
      n = n.parent ? nodes[n.parent] : null;
    }
    chain.reverse();
    return chain.map(node=>{
      const role = node?.message?.author?.role || "unknown";
      const t = node?.message?.create_time;
      const text = extractText(node.message);
      return {role, t: (typeof t==="number")?t:null, text: text||""};
    }).filter(m=>m.text.trim().length>0 && (m.role==="user" || m.role==="assistant"));
  }

  // keyword/token
  const STOP_EN = new Set(["the","and","for","with","that","this","you","your","are","was","were","have","has","had","but","not","can","could","would","should","make","please","just","like","also","then","than","from","into","about","what","how","why","when","where"]);
  const STOP_HE = new Set(["◊©◊ú","◊¢◊ú","◊¢◊ù","◊û◊î","◊ê◊ô◊ö","◊ú◊û◊î","◊û◊™◊ô","◊ê◊ô◊§◊î","◊ñ◊î","◊ñ◊ê◊™","◊ê◊†◊ô","◊ê◊™◊î","◊ê◊™","◊ê◊†◊ó◊†◊ï","◊î◊ù","◊î◊ü","◊õ◊ü","◊ú◊ê","◊í◊ù","◊õ◊ô","◊ê◊ù","◊ê◊ñ","◊õ◊û◊ï","◊®◊ß","◊¢◊ï◊ì","◊ô◊ï◊™◊®","◊û◊ê◊ï◊ì","◊ê◊§◊©◊®","◊¶◊®◊ô◊ö","◊ë◊ë◊ß◊©◊î","◊î◊ê◊ù"]);
  function isHeb(w){ return /[\u0590-\u05FF]/.test(w); }
  function tokenize(text){
    const t = (text||"").toLowerCase()
      .replace(/https?:\/\/\S+/g," ")
      .replace(/[^\p{L}\p{N}\s]/gu," ")
      .replace(/\s+/g," ")
      .trim();
    if(!t) return [];
    return t.split(" ").filter(w=>w.length>=3);
  }
  function topN(map,n){
    return Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,n);
  }

  // signature patterns (user)
  const SIG_PATTERNS = [
    ["Rewrite / humanize", ["humanize","less ai","rewrite","tone","human"]],
    ["Make it clearer", ["simplify","explain","clarify","clearer","◊™◊°◊ë◊ô◊®","◊ú◊î◊°◊ë◊ô◊®","◊§◊©◊ï◊ò","◊™◊§◊©◊ò","◊°◊ë◊ô◊®"]],
    ["Give options", ["options","variants","3 options","4 options","◊ê◊§◊©◊®◊ï◊ô◊ï◊™"]],
    ["Make a prompt", ["prompt","style prompt","◊§◊®◊ï◊û◊§◊ò"]],
    ["Build a diagram", ["mermaid","diagram","flow","chart","◊™◊®◊©◊ô◊ù"]],
    ["Browser-first build", ["github pages","browser","canvas","index.html","github"]],
  ];

  // chart draw
  function drawChart(months, counts, userShare){
    const canvas = $("chart");
    const c = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height;
    c.clearRect(0,0,W,H);
    c.fillStyle = "rgba(255,255,255,.02)";
    c.fillRect(0,0,W,H);

    const pad = 18;
    const iw = W - pad*2;
    const ih = H - pad*2;

    c.strokeStyle="rgba(255,255,255,.08)";
    c.lineWidth=2;
    c.beginPath(); c.moveTo(pad,pad); c.lineTo(pad,H-pad); c.lineTo(W-pad,H-pad); c.stroke();

    if(!months.length){
      c.fillStyle="rgba(255,255,255,.55)";
      c.font="14px ui-sans-serif, system-ui";
      c.fillText("Import conversations.json to draw timeline", pad+10, H/2);
      return;
    }

    const maxV = Math.max(...counts, 1);
    const n = months.length;
    const step = iw / Math.max(1,n-1);

    // line
    c.strokeStyle="rgba(98,246,210,.85)";
    c.lineWidth=3;
    c.beginPath();
    for(let i=0;i<n;i++){
      const x = pad + step*i;
      const y = pad + ih - (counts[i]/maxV)*ih;
      if(i===0) c.moveTo(x,y); else c.lineTo(x,y);
    }
    c.stroke();

    // area
    c.fillStyle="rgba(98,246,210,.12)";
    c.beginPath();
    for(let i=0;i<n;i++){
      const x = pad + step*i;
      const y = pad + ih - (counts[i]/maxV)*ih;
      if(i===0) c.moveTo(x,y); else c.lineTo(x,y);
    }
    c.lineTo(pad + step*(n-1), pad+ih);
    c.lineTo(pad, pad+ih);
    c.closePath();
    c.fill();

    // bars user share
    for(let i=0;i<n;i++){
      const x = pad + step*i;
      const h = userShare[i]*ih;
      c.fillStyle="rgba(255,122,217,.22)";
      c.fillRect(x-3, pad+ih-h, 6, h);
    }

    // labels
    c.fillStyle="rgba(255,255,255,.55)";
    c.font="12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas";
    c.fillText(months[0], pad, pad-4);
    c.fillText(months[n-1], W-pad-70, pad-4);
  }

  function analyze(convos){
    const perMonth = new Map();
    const perMonthUser = new Map();
    const daySet = new Set();
    const kw = new Map();
    const sig = new Map();

    let userMsgs=0, asstMsgs=0, userWords=0;
    let minT=Infinity, maxT=-Infinity;
    let convoCount=0, msgCount=0;

    for(const conv of convos || []){
      const msgs = linearize(conv);
      if(!msgs.length) continue;
      convoCount++;
      for(const m of msgs){
        msgCount++;
        if(m.role==="user"){ userMsgs++; userWords += wordsCount(m.text); }
        if(m.role==="assistant"){ asstMsgs++; }

        if(typeof m.t==="number"){
          minT = Math.min(minT, m.t);
          maxT = Math.max(maxT, m.t);
          const d = new Date(m.t*1000);
          daySet.add(fmtDate(d));
          const ym = d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
          perMonth.set(ym, (perMonth.get(ym)||0)+1);
          if(m.role==="user") perMonthUser.set(ym,(perMonthUser.get(ym)||0)+1);
        }

        // keywords
        const toks = tokenize(m.text);
        for(const w of toks){
          if(isHeb(w)){ if(STOP_HE.has(w)) continue; }
          else { if(STOP_EN.has(w)) continue; }
          kw.set(w, (kw.get(w)||0)+1);
        }

        // signature patterns (user only)
        if(m.role==="user"){
          const low = m.text.toLowerCase();
          for(const [label, arr] of SIG_PATTERNS){
            for(const p of arr){
              if(low.includes(p)){
                sig.set(label, (sig.get(label)||0)+1);
                break;
              }
            }
          }
        }
      }
    }

    const months = Array.from(perMonth.keys()).sort();
    const counts = months.map(m=>perMonth.get(m)||0);
    const userShare = months.map(m=>{
      const tot = perMonth.get(m)||0;
      const u = perMonthUser.get(m)||0;
      return tot ? (u/tot) : 0;
    });

    const range = (minT!==Infinity && maxT!==-Infinity)
      ? `${new Date(minT*1000).getFullYear()}-${String(new Date(minT*1000).getMonth()+1).padStart(2,"0")} ‚Üí ${new Date(maxT*1000).getFullYear()}-${String(new Date(maxT*1000).getMonth()+1).padStart(2,"0")}`
      : "‚Äî";

    // simple vibe
    const avgMsgsPerConvo = convoCount ? (msgCount / convoCount) : 0;
    let vibe = "Balanced builder with taste";
    if(avgMsgsPerConvo > 25) vibe = "Deep threads, high iteration";
    else if(avgMsgsPerConvo > 14) vibe = "Iterative refinement energy";
    else if(avgMsgsPerConvo > 7) vibe = "Pragmatic + exploratory mix";

    let mode = "Co-creator";
    const topSig = topN(sig,1)[0]?.[0];
    if(topSig?.includes("prompt")) mode = "Creative director";
    if(topSig?.includes("diagram")) mode = "Systems mapper";
    if(topSig?.includes("Rewrite")) mode = "Tone & clarity polisher";

    return {
      convoCount, msgCount, userMsgs, asstMsgs, userWords,
      days: daySet.size, range, months, counts, userShare,
      topKeywords: topN(kw, 12),
      topSig: topN(sig, 6),
      vibe, mode
    };
  }

  function render(stats){
    $("pillStats").textContent = "Stats: Real";
    $("pillRange").textContent = "Range: " + stats.range;

    $("vibe").textContent = stats.vibe;
    $("vibeHint").textContent = `Based on ${fmtInt(stats.msgCount)} messages across ${fmtInt(stats.convoCount)} conversations.`;
    $("mode").textContent = stats.mode;
    $("modeTag").textContent = "(computed)";
    $("modeHint").textContent = `User messages: ${fmtInt(stats.userMsgs)} ¬∑ Assistant: ${fmtInt(stats.asstMsgs)}.`;

    $("kConvos").textContent = fmtInt(stats.convoCount);
    $("kMsgs").textContent = fmtInt(stats.msgCount);
    $("kRatio").textContent = `${fmtInt(stats.userMsgs)} user ¬∑ ${fmtInt(stats.asstMsgs)} assistant`;
    $("kWords").textContent = fmtInt(stats.userWords);
    $("kDays").textContent = fmtInt(stats.days);

    // signature list
    const sigWrap = $("sig");
    sigWrap.innerHTML = "";
    if(!stats.topSig.length){
      sigWrap.innerHTML = `<div class="kv"><div class="dot b"></div><div><b>No patterns detected</b><span>This can happen if your export lacks text messages.</span></div></div>`;
    } else {
      const dots = ["b","d","a","c","e"];
      stats.topSig.forEach(([label,count],i)=>{
        const dot = dots[i % dots.length];
        const div = document.createElement("div");
        div.className="kv";
        div.innerHTML = `<div class="dot ${dot}"></div><div><b>${label}</b><span>${fmtInt(count)} matched messages</span></div>`;
        sigWrap.appendChild(div);
      });
    }

    // keywords
    const kwWrap = $("kw");
    kwWrap.innerHTML = "";
    if(!stats.topKeywords.length){
      kwWrap.innerHTML = `<div class="kv"><div class="dot a"></div><div><b>No keywords found</b><span>Try a larger export.</span></div></div>`;
    } else {
      const div = document.createElement("div");
      div.className="kv";
      div.innerHTML = `<div class="dot a"></div><div><b>Top keywords</b><span>${stats.topKeywords.map(([k,v])=>`${k} (${fmtInt(v)})`).join(" ¬∑ ")}</span></div>`;
      kwWrap.appendChild(div);
    }

    drawChart(stats.months, stats.counts, stats.userShare);

    // cache
    localStorage.setItem("dorgpt_stats_cache_v0", JSON.stringify(stats));
    confetti(120);
    showToast(`Imported ‚úÖ Built from <b>${fmtInt(stats.msgCount)}</b> messages.`);
  }

  // Parse & Build
  $("btnParse").addEventListener("click", async ()=>{
    try{
      if(!selected) return;
      $("status").textContent = "Reading file...";
      const txt = await readText(selected);
      const data = safeJson(txt);
      if(!data){ throw new Error("Could not parse JSON. Make sure this is conversations.json"); }
      if(!Array.isArray(data)){ throw new Error("Unexpected format. conversations.json should be an array."); }
      $("status").textContent = "Analyzing conversations...";
      const stats = analyze(data);
      render(stats);
      closeModal();
    }catch(err){
      console.error(err);
      $("status").textContent = "Error: " + (err?.message || "unknown");
      showToast(`‚ùå ${err?.message || "Import failed"}`, 4200);
    }
  });

  // Load cached stats if present
  try{
    const cached = localStorage.getItem("dorgpt_stats_cache_v0");
    if(cached){
      const stats = JSON.parse(cached);
      if(stats && stats.msgCount){ render(stats); $("sub").textContent = "Loaded cached stats (Reset clears)."; }
    } else {
      drawChart([],[],[]);
      showToast(`Tip: click <b>Import Stats</b> and upload <code>conversations.json</code>.`, 4200);
    }
  }catch(_){
    drawChart([],[],[]);
  }
</script>
</body>
</html>
